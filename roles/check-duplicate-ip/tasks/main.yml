---
# roles/check-duplicate-ip/tasks/main.yml

- name: "Passo 1: Obter a lista de Datacenters do vCenter"
  community.vmware.vmware_datacenter_info:
    hostname: "{{ lookup('env', 'VMWARE_HOST') }}"
    username: "{{ lookup('env', 'VMWARE_USER') }}"
    password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
    validate_certs: no
  register: dc_info
  delegate_to: localhost

- name: "Passo 2: Obter informa√ß√µes dos Clusters por Datacenter"
  community.vmware.vmware_cluster_info:
    hostname: "{{ lookup('env', 'VMWARE_HOST') }}"
    username: "{{ lookup('env', 'VMWARE_USER') }}"
    password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
    validate_certs: no
    datacenter: "{{ item.name }}"
  loop: "{{ dc_info.datacenter_info }}"
  register: cluster_info
  delegate_to: localhost
  no_log: true

- name: "Passo 3: Consolidar lista de todos os hosts em mem√≥ria"
  ansible.builtin.set_fact:
    lista_de_hosts: >-
      {%- set hosts = [] -%}
      {%- for res in cluster_info.results -%}
        {%- if res.clusters is defined -%}
          {%- for c_name, c_data in res.clusters.items() -%}
            {%- if c_data.hosts is defined -%}
              {%- for h in c_data.hosts -%}
                {%- if h.name is defined -%}
                  {%- set _ = hosts.append(h.name) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
      {{ hosts | unique }}

- name: "DEBUG: Verificar se a lista de hosts foi preenchida"
  ansible.builtin.debug:
    var: lista_de_hosts

- name: "Passo 4: Coletar Facts de rede de TODOS os hosts encontrados"
  community.vmware.vmware_host_facts:
    hostname: "{{ lookup('env', 'VMWARE_HOST') }}"
    username: "{{ lookup('env', 'VMWARE_USER') }}"
    password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
    validate_certs: no
    esxi_hostname: "{{ item }}"
  loop: "{{ lista_de_hosts }}"
  register: all_hosts_facts
  delegate_to: localhost
  ignore_errors: yes
  no_log: true

- name: "Passo 5: Mapear todos os IPs encontrados (Processamento Jinja2)"
  ansible.builtin.set_fact:
    mapeamento_ips: >-
      {%- set lista_ips = [] -%}
      {%- for host_data in all_hosts_facts.results | default([]) -%}
        {%- if host_data.ansible_facts is defined -%}
          {%- set nome_host = host_data.item -%}
          {%- set fatos = host_data.ansible_facts -%}
          {%- if fatos.ansible_interfaces is defined -%}
            {%- for interface in fatos.ansible_interfaces -%}
              {%- set chave_vmk = 'ansible_' + interface -%}
              {%- if chave_vmk in fatos and fatos[chave_vmk].ipv4 is defined -%}
                {%- set ip_addr = fatos[chave_vmk].ipv4.address -%}
                {# Ignora IPs Link-Local (vSAN interno) e Loopback #}
                {%- if not ip_addr.startswith('169.254.') and not ip_addr.startswith('127.0.') -%}
                  {%- set _ = lista_ips.append({'host': nome_host, 'device': interface, 'ip': ip_addr}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{ lista_ips }}

- name: "Passo 6: Agrupar IPs por endere√ßo e detectar duplicidades"
  ansible.builtin.set_fact:
    ips_duplicados: >-
      {%- set contagem = {} -%}
      {%- for item in mapeamento_ips -%}
        {%- if item.ip not in contagem -%}
          {%- set _ = contagem.update({item.ip: []}) -%}
        {%- endif -%}
        {%- set _ = contagem[item.ip].append(item.host ~ ' (' ~ item.device ~ ')') -%}
      {%- endfor -%}
      {%- set duplicados = {} -%}
      {%- for ip, locais in contagem.items() -%}
        {%- if locais | length > 1 -%}
          {%- set _ = duplicados.update({ip: locais}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ duplicados }}

- name: "Passo 7: Formatar a mensagem de alerta (slack_msg)"
  ansible.builtin.set_fact:
    slack_msg: >-
      üö® *ALERTA CR√çTICO: Conflito de IP (VMkernel) Detectado!* üö®
      
      O Canivete Su√≠√ßo de Opera√ß√µes identificou endere√ßos IP duplicados na infraestrutura do vCenter.
      
      {% for ip, locais in ips_duplicados.items() %}
      *IP Duplicado:* `{{ ip }}`
      *Sendo utilizado simultaneamente em:*
      {% for local in locais %}
      ‚Ä¢ {{ local }}
      {% endfor %}
      
      {% endfor %}
      
      _Por favor, verifique a configura√ß√£o de rede desses hosts para evitar indisponibilidade de vMotion ou ger√™ncia._
  when: ips_duplicados | length > 0

- name: "Passo 8: Enviar notifica√ß√£o para o Slack via Webhook (Nativo)"
  ansible.builtin.uri:
    # Se voc√™ j√° tiver a vari√°vel slack_webhook_url declarada no AWX, ele usar√° ela.
    # Caso n√£o tenha, ele tentar√° puxar a env var SLACK_WEBHOOK_URL como fallback.
    url: "{{ slack_webhook_url | default(lookup('env', 'SLACK_WEBHOOK_URL')) }}"
    method: POST
    body_format: json
    body:
      text: "{{ slack_msg }}"
  delegate_to: localhost
  ignore_errors: yes
  when: 
    - ips_duplicados | length > 0
    - slack_webhook_url is defined or lookup('env', 'SLACK_WEBHOOK_URL') != ''

- name: "Passo 9: For√ßar Falha do Playbook (Hard Stop para Auditoria AWX)"
  ansible.builtin.debug:
    msg: "CR√çTICO: O IP {{ item.key }} est√° duplicado! Sendo usado em: {{ item.value | join(' E ') }}"
  loop: "{{ ips_duplicados | dict2items }}"
  when: ips_duplicados | length > 0
  failed_when: ips_duplicados | length > 0

- name: "Passo 10: Sucesso - Nenhum conflito de rede encontrado"
  ansible.builtin.debug:
    msg: "‚úÖ Verifica√ß√£o conclu√≠da com sucesso. Nenhum endere√ßo IP de VMkernel est√° duplicado na sua infraestrutura."
  when: ips_duplicados | length == 0