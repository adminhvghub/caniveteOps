- name: Extrair eventos de HA do vCenter via PowerCLI
  ansible.builtin.script:
    cmd: get_ha_events.ps1
    executable: pwsh
  register: script_output
  environment:
    VMWARE_HOST: "{{ lookup('env', 'VMWARE_HOST') }}"
    VMWARE_USER: "{{ lookup('env', 'VMWARE_USER') }}"
    VMWARE_PASSWORD: "{{ lookup('env', 'VMWARE_PASSWORD') }}"

- name: Converter saida do script para JSON
  ansible.builtin.set_fact:
    vms_ha_json: "{{ script_output.stdout | from_json }}"

- name: Verificar se houve erros na coleta
  ansible.builtin.fail:
    msg: "Erro ao coletar eventos de HA: {{ vms_ha_json.error }}"
  when: vms_ha_json is mapping and vms_ha_json.error is defined

- name: Exibir lista de VMs que sofreram HA
  ansible.builtin.debug:
    msg: 
      - "VM: {{ item.vm_name }}"
      - "Data do Evento: {{ item.data_evento }}"
      - "Detalhe: {{ item.mensagem }}"
      - "----------------------------------------"
  loop: "{{ vms_ha_json }}"
  when: vms_ha_json is iterable and (vms_ha_json | type_debug == 'list') and vms_ha_json | length > 0

- name: Notificar que nenhuma VM sofreu HA recentemente
  ansible.builtin.debug:
    msg: "Nenhum evento de High Availability (HA) foi encontrado no vCenter."
  when: vms_ha_json is iterable and (vms_ha_json | type_debug == 'list') and vms_ha_json | length == 0