---
# 1. Garante que a biblioteca está instalada no ambiente do Ansible
- name: Garantir que a biblioteca pyvmomi esta instalada
  ansible.builtin.pip:
    name: pyvmomi>=8.0.0
    state: present
  delegate_to: localhost
  run_once: true

# 2. Executa o script passando o executável do próprio Ansible para não perder a dependência
- name: Extrair eventos de HA do vCenter via pyVmomi
  ansible.builtin.script:
    cmd: get_ha_events.py
    executable: "{{ ansible_playbook_python }}"
  register: script_output
  delegate_to: localhost
  environment:
    VMWARE_HOST: "{{ lookup('env', 'VMWARE_HOST') }}"
    VMWARE_USER: "{{ lookup('env', 'VMWARE_USER') }}"
    VMWARE_PASSWORD: "{{ lookup('env', 'VMWARE_PASSWORD') }}"

# 3. Converte a saída String para um objeto JSON (Lista ou Dicionário)
- name: Converter saida do script para JSON
  ansible.builtin.set_fact:
    vms_ha_json: "{{ script_output.stdout | from_json }}"

# 4. Falha se o Python retornou o dicionário {"error": "..."}
- name: Verificar se houve erros na coleta
  ansible.builtin.fail:
    msg: "Erro ao coletar eventos de HA: {{ vms_ha_json.error }}"
  when: 
    - vms_ha_json is mapping
    - vms_ha_json.error is defined

# 5. Exibe as VMs encontradas (Itera a Lista)
- name: Exibir lista de VMs que sofreram HA
  ansible.builtin.debug:
    msg: 
      - "VM: {{ item.vm_name }}"
      - "Data do Evento: {{ item.data_evento }}"
      - "Detalhe: {{ item.mensagem }}"
      - "Tipo: {{ item.tipo_evento }}"
      - "----------------------------------------"
  loop: "{{ vms_ha_json }}"
  when: 
    - vms_ha_json | type_debug == 'list'
    - vms_ha_json | length > 0

# 6. Exibe aviso caso a lista venha vazia
- name: Notificar que nenhuma VM sofreu HA recentemente
  ansible.builtin.debug:
    msg: "Nenhum evento de High Availability (HA) foi encontrado nas ultimas 24h."
  when: 
    - vms_ha_json | type_debug == 'list'
    - vms_ha_json | length == 0