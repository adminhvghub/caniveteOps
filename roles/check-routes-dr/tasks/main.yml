---
# roles/check-routes-dr/tasks/main.yml

- name: Garantir que a biblioteca pyvmomi esta instalada
  ansible.builtin.pip:
    name: pyvmomi>=8.0.0
    state: present
  delegate_to: localhost
  run_once: true

- name: Extrair tabela de roteamento de todos os hosts ESXi via pyVmomi
  ansible.builtin.script:
    cmd: get_esxi_routes.py
    executable: "{{ ansible_playbook_python }}"
  register: script_output
  delegate_to: localhost
  environment:
    VMWARE_HOST: "{{ lookup('env', 'VMWARE_HOST') }}"
    VMWARE_USER: "{{ lookup('env', 'VMWARE_USER') }}"
    VMWARE_PASSWORD: "{{ lookup('env', 'VMWARE_PASSWORD') }}"

- name: Verificar se houve erros na coleta do script Python
  ansible.builtin.fail:
    msg: "O script falhou: {{ (script_output.stdout | from_json).error }}"
  when: 
    - script_output.stdout is defined
    - (script_output.stdout | from_json).error is defined

- name: Converter saida do script para dicionario nativo
  ansible.builtin.set_fact:
    tabela_rotas: "{{ script_output.stdout | from_json }}"

# ================= NOVA AUDITORIA COME√áA AQUI =================

- name: Definir as Rotas Estaticas Obrigatorias de DR (Golden Image)
  ansible.builtin.set_fact:
    rotas_dr_obrigatorias:
      - { rede: "10.100.160.0", mascara: 22, gateway: "10.108.148.2" }
      - { rede: "10.100.160.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.100.160.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.100.168.0", mascara: 22, gateway: "10.108.148.2" }
      - { rede: "10.100.168.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.100.168.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.100.168.7", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.100.168.8", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.114.136.0", mascara: 22, gateway: "10.108.148.2" }
      - { rede: "10.114.136.0", mascara: 21, gateway: "10.108.148.2" }
      - { rede: "10.114.144.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.114.144.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.114.144.7", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.114.144.8", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.118.136.0", mascara: 21, gateway: "10.108.148.2" }
      - { rede: "10.118.144.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.118.144.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.118.144.7", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "10.118.144.8", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.144.0", mascara: 22, gateway: "10.108.148.2" }
      - { rede: "172.18.144.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.144.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.148.5", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.148.6", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.148.7", mascara: 32, gateway: "10.108.148.2" }
      - { rede: "172.18.148.8", mascara: 32, gateway: "10.108.148.2" }

- name: Inspecionar todos os hosts buscando rotas faltantes (Processamento Jinja2)
  ansible.builtin.set_fact:
    hosts_com_falha: >-
      {%- set falhas = {} -%}
      {%- for host_name, rotas_do_host in tabela_rotas.items() -%}
        {%- set rotas_ausentes = [] -%}
        
        {# Verifica cada rota obrigat√≥ria contra a tabela do host atual #}
        {%- for obrigatoria in rotas_dr_obrigatorias -%}
          {%- set rota_encontrada = namespace(existe=false) -%}
          
          {%- for r_host in rotas_do_host -%}
            {%- if r_host.rede_destino == obrigatoria.rede and r_host.mascara == obrigatoria.mascara and r_host.gateway == obrigatoria.gateway -%}
              {%- set rota_encontrada.existe = true -%}
            {%- endif -%}
          {%- endfor -%}
          
          {%- if not rota_encontrada.existe -%}
            {%- set _ = rotas_ausentes.append(obrigatoria.rede ~ '/' ~ obrigatoria.mascara ~ ' -> ' ~ obrigatoria.gateway) -%}
          {%- endif -%}
        {%- endfor -%}
        
        {# Se o host estiver com pelo menos uma rota faltando, adiciona ele ao relat√≥rio de falhas #}
        {%- if rotas_ausentes | length > 0 -%}
          {%- set _ = falhas.update({host_name: rotas_ausentes}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ falhas }}

- name: Formatar a mensagem de alerta para o Slack
  ansible.builtin.set_fact:
    slack_msg: |
      üö® *ALERTA CR√çTICO: ROTEAMENTO DE DR AUSENTE!* üö®
      
      O Canivete Su√≠√ßo de Opera√ß√µes identificou que alguns hosts ESXi perderam rotas est√°ticas de Disaster Recovery.
      {% for host, rotas in hosts_com_falha.items() %}
      
      *Host:* `{{ host }}`
      *Rotas Ausentes:*
      {% for rota in rotas %}
      ‚Ä¢ {{ rota }}
      {% endfor %}
      {% endfor %}
      
      _Favor injetar as rotas faltantes via esxcli ou host profiles._
  when: hosts_com_falha | length > 0

- name: "DUMP FINAL: Mostrar na tela o resultado da Auditoria"
  ansible.builtin.debug:
    var: hosts_com_falha


- name: Enviar notifica√ß√£o para o Slack via Webhook (Nativo)
  ansible.builtin.uri:
    url: "{{ slack_webhook_url | default(lookup('env', 'SLACK_WEBHOOK_URL')) }}"
    method: POST
    body_format: json
    body:
      text: "{{ slack_msg }}"
  delegate_to: localhost
  ignore_errors: yes
  when: 
    - hosts_com_falha | length > 0
    - slack_webhook_url is defined or lookup('env', 'SLACK_WEBHOOK_URL') != ''

- name: For√ßar Falha do Playbook (Hard Stop para Auditoria AWX)
  ansible.builtin.fail:
    msg: "üö® CR√çTICO: Encontrados hosts com rotas de DR ausentes! Verifique o log para detalhes."
  when: hosts_com_falha | length > 0

- name: Sucesso - Todas as rotas de DR validadas
  ansible.builtin.debug:
    msg: "‚úÖ Verifica√ß√£o conclu√≠da com sucesso. Todas as rotas de DR est√£o configuradas em todos os hosts."
  when: hosts_com_falha | length == 0